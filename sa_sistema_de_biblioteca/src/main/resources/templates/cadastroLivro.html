<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/geral.css" />
    <link rel="stylesheet" href="/css/cadastro-livro.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css"
      rel="stylesheet"
    />

    <link
      rel="shortcut icon"
      href="https://estudante.sesisenai.org.br/img/favicon.ico"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <title>Cadastro de Livro</title>
    <style>
      .option-with-image {
        display: flex;
        align-items: center;
      }
      .option-with-image img {
        width: 30px;
        height: 30px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div class="containerLivro">
      <h1>Cadastro de Livro</h1>
      <form id="formLivro">
        <!-- Campos do formulário -->
        <label for="titulo">Título:</label>
        <input type="text" id="titulo" name="titulo" required />

        <label for="editora">Editora:</label>
        <input type="text" id="editora" name="editora" required />

        <label for="anoPublicacao">Ano de Publicação:</label>
        <input type="date" id="anoPublicacao" name="anoPublicacao" required />

        <label for="sinopse">Sinopse:</label>
        <textarea id="sinopse" name="sinopse"></textarea>

        <label for="imagemCapa">Capa do Livro:</label>
        <input type="file" id="imagemCapa" accept="image/*" />
        <img
          id="previewCapa"
          src="#"
          alt="Preview da Capa"
          style="display: none; max-height: 150px; margin: 10px 0"
        />

        <label for="categoriaLivro">Categoria:</label>
        <select name="categoriaLivro" id="categoriaLivro"></select>

        <label for="autor">Autor:</label>
        <select
          name="autor"
          id="autor"
          placeholder="Selecione um autor..."
        ></select>

        <label for="quantidadeTotal">Quantidade Total:</label>
        <input
          min="1"
          type="number"
          id="quantidadeTotal"
          name="quantidadeTotal"
          required
        />

        <button type="submit">Cadastrar</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        async function preencherCategorias() {
          const response = await fetch("/categoria", { method: "GET" });
          if (!response.ok) throw new Error("Erro ao buscar autores.");

          const categorias = await response.json();

          const select = document.getElementById("categoriaLivro");
          console.log("Response: "+response)
          console.log("Select: "+select)
          categorias.forEach((categoria) => {
            const option = document.createElement("option");
            option.value = categoria;
            option.textContent = categoria;
            
            select.appendChild(option);
          });
        }
        try {
          preencherCategorias()
          const response = await fetch("/autor/all", { method: "GET" });
          if (!response.ok) throw new Error("Erro ao buscar autores.");

          const autores = await response.json();
          const select = document.getElementById("autor");

          // Criação das opções com imagem base64
          autores.forEach((autor) => {
            const option = document.createElement("option");
            option.value = autor.idAutor;
            option.textContent = autor.nomeAutor;
            option.setAttribute(
              "data-img",
              `data:image/png;base64,${autor.fotoAutor}`
            );
            select.appendChild(option);
          });

          // Inicialização do TomSelect
          new TomSelect("#autor", {
            render: {
              option: function (data, escape) {
                return `
            <div class="option-with-image">
              <img src="${escape(data.img)}" alt="${escape(
                  data.text
                )}" style="width:30px;height:30px;border-radius:50%;margin-right:8px;">
              <span>${escape(data.text)}</span>
            </div>`;
              },
              item: function (data, escape) {
                return `
            <div class="option-with-image">
              <img src="${escape(data.img)}" alt="${escape(
                  data.text
                )}" style="width:20px;height:20px;border-radius:50%;margin-right:6px;">
              <span>${escape(data.text)}</span>
            </div>`;
              },
            },
            onInitialize() {
              this.options = Object.fromEntries(
                [...this.select.options].map((opt) => [
                  opt.value,
                  {
                    value: opt.value,
                    text: opt.textContent,
                    img: opt.getAttribute("data-img"),
                  },
                ])
              );
            },
          });
        } catch (error) {
          console.error("Erro ao buscar autores:", error);
        }

        // Preview da imagem da capa
        document
          .getElementById("imagemCapa")
          .addEventListener("change", function () {
            const file = this.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
              const preview = document.getElementById("previewCapa");
              preview.src = e.target.result;
              preview.style.display = "block";
              preview.setAttribute(
                "data-base64",
                e.target.result.split(",")[1]
              );
            };

            if (file) reader.readAsDataURL(file);
          });

        // Submissão do formulário
        document
          .getElementById("formLivro")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const capa =
              document
                .getElementById("previewCapa")
                .getAttribute("data-base64") || "";

            const livro = {
              titulo: document.getElementById("titulo").value,
              editora: document.getElementById("editora").value,
              anoPublicacao: document.getElementById("anoPublicacao").value,
              sinopse: document.getElementById("sinopse").value,
              imagemCapa: capa,
              categoriaLivro: document.getElementById("categoriaLivro").value,
              autor: {
                idAutor: parseInt(document.getElementById("autor").value),
              },
              quantidadeTotal: parseInt(
                document.getElementById("quantidadeTotal").value
              ),
            };

            try {
              const response = await fetch("/book/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(livro),
              });

              if (response.ok) {
                alert("Livro cadastrado com sucesso!");
                document.getElementById("formLivro").reset();
                document.getElementById("previewCapa").style.display = "none";
              } else {
                alert("Erro ao cadastrar o livro.");
              }
            } catch (error) {
              alert("Erro na requisição.");
              console.error(error);
            }
          });
      });
    </script>
  </body>
</html>
